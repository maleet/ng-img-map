!function(e){"use strict";e.module("ngImgMap",["ngTouch"]).factory("ngImgMapCurArea",["$document",function(a){function r(e){e[0]>e[2]&&t(e,0,2),e[1]>e[3]&&t(e,1,3)}function t(e,a,r){var t=e[a];e[a]=e[r],e[r]=t}var i={area:void 0,mouse:[0,0],action:void 0};return a.find("body").on("mouseup",function(a){e.isDefined(i.area)&&(r(i.area.coords),delete i.area.isDraging,i.area=void 0)}),i}]).factory("ngImgMapCalculation",["$timeout",function(a){function r(e,a,r){return e>r?r:e<a?a:e}var t=function(e,a){this.dx=0,this.dy=0,this.imgw=e[0],this.imgh=e[1],this.img=[this.imgw,this.imgh],this.canw=Math.min(e[0],a[0]),this.canh=Math.min(e[1],a[1]),this.ratioh=e[1]&&this.canh?this.canh/e[1]:1,this.ratiow=e[0]&&this.canw?this.canw/e[0]:1,this.ratio=Math.min(this.ratioh,this.ratiow)};return t.prototype.init=function(e,a,r){var t=this;if(t._getOffset(a,r),0==t.dx&&0==t.dy)return!1;switch(t.curA=a,t.coords=t.curA.area.coords,t.curA.mouse=r,e[0]){case"move":t._move();break;case"resize":t._resize(e[1])}},t.prototype.getDragAction=function(a){var r=a.split(" "),t="move",i=[0,0,0,0];return e.forEach(r,function(a){switch(a){case"bar-remove":t=void 0;break;case"dragline":case"dragdot":t="resize";break;default:var r=new RegExp("ord-([nswe]+)").exec(a)||[];if(r.length){var o=r[1].split("");e.forEach(o,function(e){switch(e){case"w":i[0]=1;break;case"n":i[1]=1;break;case"e":i[2]=1;break;case"s":i[3]=1}})}}}),[t,i]},t.prototype.checkCoords=function(e){e[0]=+e[0]||0,e[1]=+e[1]||0,e[2]=+e[2]||0,e[3]=+e[3]||0;var a=this,t=0,i=0,o=e[0],n=e[1],s=e[2],c=e[3];if(o<0&&(t=-o,o=s=1),s>a.imgw&&(t=a.imgw-s,o=s=1),n<0&&(i=-n,n=c=1),c>a.imgh&&(i=a.imgh-c,n=c=1),(o||n)&&(e[0]+=o*t,e[1]+=n*i,e[2]+=s*t,e[3]+=c*i),Math.abs(e[0]-e[2])>a.imgw||Math.abs(e[1]-e[3])>a.imgh)for(var d=0,g=e.length;d<g;d++)e[d]=r(e[d],0,a.img[d%2]);return e},t.prototype._getOffset=function(e,a){var r=this;r.dx=parseInt((a[0]-e.mouse[0])/r.ratio),r.dy=parseInt((a[1]-e.mouse[1])/r.ratio)},t.prototype._move=function(){var e=this;e._checkEdge(e.coords,[e.coords[0]+e.dx,e.coords[1]+e.dy,e.coords[2]+e.dx,e.coords[3]+e.dy],[1,1,1,1])},t.prototype._resize=function(e){var a=this;a._checkEdge(a.coords,[a.coords[0]+a.dx*e[0],a.coords[1]+a.dy*e[1],a.coords[2]+a.dx*e[2],a.coords[3]+a.dy*e[3]],e)},t.prototype._checkEdge=function(e,a,r){for(var t=this,i=0,o=a.length;i<o;i++)if(a[i]>t.img[i%2]||a[i]<0){a[i]=e[i];var n=(i+2)%4;r[n]&&(a[n]=e[n])}t.curA.area.coords=a},t}]).controller("ngImgMapCtrl",["$scope","ngImgMapCalculation","ngImgMapCurArea",function(a,r,t){function i(){return n=a.ngImgMapFns,s=a.m=a.ngModel,e.isUndefined(s)?console.warn("ngImgMap need correct ngModel, please check data & format!"):(n&&e.isFunction(n.getImgSize)?c=n.getImgSize(s)||[1e3,100]:(c=[1e3,100],console.warn("ngImgMap need fn to get ImgSize, now use [1000, 100] !")),n&&e.isFunction(n.getCanSize)?d=n.getCanSize(s)||[1e3,100]:(d=[1e3,100],console.warn("ngImgMap need fn to get CanSize, now use [1000, 100] !")),g=new r(c,d),u=g.ratio,s.getCalculation=function(){return g},e.isDefined(s)&&e.forEach(s.maps,function(e){e.ratio=u,g.checkCoords(e.coords)}),void(a.wrapperStyle=function(){var e=g.img;return{width:e[0]*u+"px",height:e[1]*u+"px","background-image":"url("+s.pic_url+")"}}()))}function o(e){var a=e.originalEvent||e;return"touchstart"!=a.type&&"touchmove"!=a.type||(a=a.touches[0]),a}var n,s,c,d,g,u,v=a.curArea=t,m=null;i(),a.$watch("m.pic_url",function(){g&&i()}),a.catchArea=function(a,r){if(a.preventDefault(),a.stopPropagation(),e.isDefined(r)&&r.coords){m=r,v.area=r;var t=o(a);v.mouse=[t.pageX,t.pageY],v.action=g.getDragAction(a.target.className),["move","resize"].indexOf(v.action[0])>-1&&(v.area.isDraging=!0)}},a.trackMove=function(a){if(a.stopPropagation(),m==v.area){var r=v.action;if(e.isDefined(v.area)&&e.isDefined(r[0])&&v.area.coords){var t=o(a);g.init(r,v,[t.pageX,t.pageY])}}},a.stopMove=function(e,a){delete a.isDraging,m=void 0},a.removeArea=function(a,r){e.isDefined(a[r])&&a.splice(r,1)},a.getAreaStyle=function(e){var a=e.coords||[10,10,50,50];return{width:parseInt(Math.abs(a[0]-a[2])*u)+"px",height:parseInt(Math.abs(a[1]-a[3])*u)+"px",left:parseInt(Math.min(a[0],a[2])*u)+"px",top:parseInt(Math.min(a[1],a[3])*u)+"px"}},a.getCurSize=function(e){var a=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]);return[a,r].join(" * ")}}]).directive("ngImgMap",["$timeout",function(e){return{restrict:"EA",scope:{ngImgMapFns:"=ngImgMapFns",ngModel:"=ngModel",readOnly:"="},templateUrl:"ngImgMap.html",controller:"ngImgMapCtrl"}}]).run(["$templateCache",function(e){var a='<div class="img-map-wrapper" ng-class="{readonly: readOnly}" ng-mousemove="trackMove($event)" ng-style="wrapperStyle">    <div ng-repeat="area in m.maps" class="map-area"  ng-mousedown="catchArea($event, area)" ng-touchmove="trackMove($event)" ng-touchstart="catchArea($event, area)" ng-class="{draging: area.isDraging}" ng-touchend="stopMove($event, area)" ng-style="getAreaStyle(area)">        <div class="dragbar">            <div class="bar-title">{{$index+1}}</div>            <div ng-if="curArea.area == area" class="bar-remove" ng-click="removeArea(m.maps, $index)" ng-touchstart="removeArea(m.maps, $index)">&times;</div>            <div class="bar-size">{{getCurSize(area.coords)}}</div>            <div class="bar-coords">{{area.coords}}</div>        </div>        <div class="ord-n dragline"></div>        <div class="ord-e dragline"></div>        <div class="ord-s dragline"></div>        <div class="ord-w dragline"></div>        <div class="ord-n dragdot"></div>        <div class="ord-e dragdot"></div>        <div class="ord-s dragdot"></div>        <div class="ord-w dragdot"></div>        <div class="ord-nw dragdot"></div>        <div class="ord-ne dragdot"></div>        <div class="ord-sw dragdot"></div>        <div class="ord-se dragdot"></div>    </div></div>';e.put("ngImgMap.html",a)}])}(angular);